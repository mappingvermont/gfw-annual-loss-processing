# gfw-create-umd-summary-excel

This repo builds a user-friendly representation of the loss data. The currrent spreadsheet can be downloaded [here](http://www.globalforestwatch.org/countries/overview).

#### Source Data
---

Input data for this process need be in a folder named `source` and in the following format:

extent2000.csv and extent2010.csv: 
```
polyname,bound1,bound2,bound3,bound4,iso,adm1,adm2,thresh,area
gadm28_large,-9999,-9999,-9999,-9999,ABW,-9999,-9999,0,789.472422274
gadm28_large,-9999,-9999,-9999,-9999,ABW,-9999,-9999,10,215.63393755
```

loss.csv:
```
polyname,bound1,bound2,bound3,bound4,iso,adm1,adm2,thresh,year,area,emissions
gadm28_large,-9999,-9999,-9999.0,-9999.0,ABW,-9999,-9999,0,2001,0.150338202551,0.150338202551
gadm28_large,-9999,-9999,-9999.0,-9999.0,ABW,-9999,-9999,0,2002,0.601265311472,53.1368823032
```

gain.csv
```
polyname,bound1,bound2,bound3,bound4,iso,adm1,adm2,area
gadm28_large,-9999,-9999,-9999.0,-9999.0,ABW,-9999,-9999,1.05219989517
gadm28_large,-9999,-9999,-9999.0,-9999.0,AFG,1,1,0.493522650078
```

Loss and extent data need to be cumsummed by threshold for this process to work. Directory 2 of this repo (Cumulate Results) can take care of that if the data is not yet processeed. The example data files above include additional polyname and bound fields generated by folders 1a, 1b, and 1c of this repo. These fields are extraneous for this purpose, but will likely be present in the data at this point.

#### Organizing this data
---
Download all the files above (extent2000, extent2010, loss, gain) into the `source` directory.

Then run `load_data.py`. This brings all the source data into a SQLite3 database for easy querying. Given the memory required by this process, it should be run in 64 bit python on a decent machine.

#### Writing summary files

Given the particular output format required, we need to jump through a few hoops regarding pandas/openpyxl versions. Follow these steps to write summary files:

```bash
# create a virtualenv and activate it
virtualenv venv
source venv/bin/activate

# install proper numpy, pandas, and openpyxl versions
pip install numpy==1.8.1 --no-binary numpy
pip install pandas==0.16.0 --no-binary pandas
pip install openpyxl==1.8.6

# run code to generate spreadsheet from within the virtualenv
python write_summary_file.py -l 1

# leave virtualenv
deactivate
```

#### Postprocess the spreadsheet
---
To add proper highlighting/column widths, first **deactivate** the virtualenv, then run the following:
```
python postprocess.py -i <path to input sheet> -o <output path>
```

#### Batch processing
````
virtualenv venv
source venv/bin/activate

# generate spreadsheets for all ISO codes
python batch_process.py -t raw

# postprocess all spreadsheets
# first deactivate virtualenv
deactivate

# then apply formatting
python batch_process.py -t postprocess
````

#### Example output
For an example of this output, see `example_output.xlsx`.
